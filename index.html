<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Route Elevation & Energy Analysis</title>
  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <style>
    body { font-family: sans-serif; max-width: 900px; margin: auto; padding: 1em; }
    #map { width: 100%; height: 400px; margin-bottom: 1em; }
    fieldset { border:1px solid #ccc; padding:0.8em; margin-top:1em; }
    legend { font-weight: bold; }
    form div { margin-bottom: 0.8em; }
    label { display:inline-block; width:180px; }
    input[type="number"] { width:120px; }
    #results p { margin:0.2em 0; }
    #elevationChart { margin-top:1em; }
  </style>
</head>
<body>
  <h1>Route Elevation & Energy Analysis</h1>

  <div id="map"></div>
  <div>
    <label><input type="radio" name="mode" value="start" checked /> Select Start</label>
    <label><input type="radio" name="mode" value="end" /> Select End</label>
  </div>

  <form id="route-form">
    <!-- Coordinates -->
    <fieldset>
      <legend>Route Coordinates</legend>
      <div>
        <label for="start-lat">Start Latitude:</label>
        <input id="start-lat" type="number" step="any" value="37.7749" />
      </div>
      <div>
        <label for="start-lon">Start Longitude:</label>
        <input id="start-lon" type="number" step="any" value="-122.4194" />
      </div>
      <div>
        <label for="end-lat">End Latitude:</label>
        <input id="end-lat" type="number" step="any" value="34.0522" />
      </div>
      <div>
        <label for="end-lon">End Longitude:</label>
        <input id="end-lon" type="number" step="any" value="-118.2437" />
      </div>
    </fieldset>

    <!-- Energy Parameters -->
    <fieldset>
      <legend>Truck & Energy Parameters</legend>
      <div>
        <label for="mass">Mass (kg):</label>
        <input id="mass" type="number" step="1" value="30000" />
      </div>
      <div>
        <label for="speed_kmh">Speed (km/h):</label>
        <input id="speed_kmh" type="number" step="0.1" value="72" />
      </div>
      <div>
        <label for="Crr">Rolling Resistance (Crr):</label>
        <input id="Crr" type="number" step="0.001" value="0.007" />
      </div>
      <div>
        <label for="Cd">Drag Coefficient (Cd):</label>
        <input id="Cd" type="number" step="0.01" value="0.6" />
      </div>
      <div>
        <label for="A">Frontal Area (m²):</label>
        <input id="A" type="number" step="0.1" value="8" />
      </div>
      <div>
        <label for="rho">Air Density (kg/m³):</label>
        <input id="rho" type="number" step="0.01" value="1.225" />
      </div>
      <div>
        <label for="eff">Drivetrain Eff. (0–1):</label>
        <input id="eff" type="number" step="0.01" value="0.9" />
      </div>
      <div>
        <label for="regenEff">Regen Eff. (0–1):</label>
        <input id="regenEff" type="number" step="0.01" value="0.6" />
      </div>
    </fieldset>

    <button type="submit">Analyze Route & Energy</button>
  </form>

  <div id="results"></div>
  <canvas id="elevationChart" width="800" height="400"></canvas>

  <!-- External Libraries -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Project Scripts: order matters! -->
  <script src="energy.js"></script>
  <script src="weather.js"></script>
  <script src="climate_api.js"></script>

  <script>
    let chart;
    const map = L.map("map").setView([37.7749, -122.4194], 5);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; OpenStreetMap contributors",
    }).addTo(map);

    let startMarker, endMarker, routeLine;

    map.on("click", (e) => {
      const { lat, lng } = e.latlng;
      const mode = document.querySelector('input[name="mode"]:checked').value;
      if (mode === "start") {
        startMarker && map.removeLayer(startMarker);
        startMarker = L.marker([lat, lng]).addTo(map).bindPopup("Start").openPopup();
        document.getElementById("start-lat").value = lat.toFixed(6);
        document.getElementById("start-lon").value = lng.toFixed(6);
      } else {
        endMarker && map.removeLayer(endMarker);
        endMarker = L.marker([lat, lng]).addTo(map).bindPopup("End").openPopup();
        document.getElementById("end-lat").value = lat.toFixed(6);
        document.getElementById("end-lon").value = lng.toFixed(6);
      }
    });

    document.getElementById("route-form").addEventListener("submit", async (e) => {
      e.preventDefault();

      // Read coords
      const sLat = +document.getElementById("start-lat").value;
      const sLon = +document.getElementById("start-lon").value;
      const eLat = +document.getElementById("end-lat").value;
      const eLon = +document.getElementById("end-lon").value;

      // Read energy params
      const params = {
        mass:      +document.getElementById("mass").value,
        speed_kmh: +document.getElementById("speed_kmh").value,
        Crr:       +document.getElementById("Crr").value,
        Cd:        +document.getElementById("Cd").value,
        A:         +document.getElementById("A").value,
        rho:       +document.getElementById("rho").value,
        eff:       +document.getElementById("eff").value,
        regenEff:  +document.getElementById("regenEff").value
      };

      const out = document.getElementById("results");
      out.innerHTML = "<p>Calculating…</p>";

      try {
        // 1) Fetch route waypoints
        const routeRes = await fetch(
          `https://router.project-osrm.org/route/v1/driving/${sLon},${sLat};${eLon},${eLat}?overview=full&geometries=geojson`
        );
        if (!routeRes.ok) throw new Error(`OSRM error: ${routeRes.status}`);
        const routeData = await routeRes.json();
        const waypoints = routeData.routes[0].geometry.coordinates.map((pt) => [pt[1], pt[0]]);

        // 2) Draw route
        routeLine && map.removeLayer(routeLine);
        routeLine = L.polyline(waypoints, { color: "blue", weight: 4 }).addTo(map);
        map.fitBounds(routeLine.getBounds());

        // 3) Fetch elevations
        const elevRes = await fetch("https://api.open-elevation.com/api/v1/lookup", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ locations: waypoints.map(([lat, lon]) => ({ latitude: lat, longitude: lon })) })
        });
        if (!elevRes.ok) throw new Error(`Elevation error: ${elevRes.status}`);
        const elevData = await elevRes.json();
        const elevations = elevData.results.map((r) => r.elevation);

        // 4) Calculate elevation gain/loss
        let gain = 0, loss = 0;
        for (let i = 1; i < elevations.length; i++) {
          const d = elevations[i] - elevations[i - 1];
          if (d > 0) gain += d; else loss += Math.abs(d);
        }
        out.innerHTML = `<p>Waypoints: ${waypoints.length}</p><p>Gain: ${gain.toFixed(1)} m, Loss: ${loss.toFixed(1)} m</p>`;

        // 5) Base energy
        const base = calculateEnergy(waypoints, elevations, params);

        // 6) Historical climate normals
        const climate = await getRouteClimate(waypoints);
        out.innerHTML += `<p>Climate Avg: ${climate.temp.toFixed(1)}°C, ${climate.precipitation.toFixed(1)}mm rain, ${climate.snow.toFixed(1)}mm snow, ${climate.wind.toFixed(1)}m/s wind</p>`;

        // 7) Weather impact
        const factor = calculateWeatherImpact(climate);
        const adjustedJ = base.Ejoules * factor;
        const totalKwh = adjustedJ / 3.6e6;
        const distanceKm = base.distance_m / 1000;
        const cpkm = (totalKwh / distanceKm).toFixed(3);

        out.innerHTML += `<p>Adjusted Energy: ${totalKwh.toFixed(2)} kWh</p><p><strong>Consumption:</strong> ${cpkm} kWh/km</p>`;

        // 8) Plot elevation profile
        const ctx = document.getElementById("elevationChart").getContext("2d");
        const labels = elevations.map((_, i) => i);
        if (chart) chart.destroy();
        chart = new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets: [{ label: "Elevation (m)", data: elevations, fill: false, tension: 0.1 }]
          },
          options: {
            scales: {
              x: { title: { display: true, text: "Waypoint Index" } },
              y: { title: { display: true, text: "Elevation (m)" } }
            }
          }
        });
      } catch (err) {
        out.innerHTML = `<p style="color:red">Error: ${err.message}</p>`;
        console.error(err);
      }
    });
  </script>
</body>
</html>
